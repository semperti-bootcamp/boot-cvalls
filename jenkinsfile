pipeline {


    agent {
        node (){
            label 'bc-cvalls'
        } 
    }
    environment {
        ANSIBLE_HOST_KEY_CHECKING = 'false'
          registry = "christianvalls1986/test_java"
           registryCredential = 'dockercvalls'
		   AppVersion = "2.0.11"
    }

    stages {   
     
      stage('pull Image') {
        steps{
          script {
            sh "docker pull christianvalls1986/test_java:$AppVersion" 
          }
        }
      }
      
       stage('Run Image') {
        steps{
          script {
            sh "docker run  -d -it --net=host -t -p 8080:8080 christianvalls1986/test_java:$AppVersion" 
          }
	  timeout(300) {
		    waitUntil {
		       script {3
			 def r = sh script: 'curl http://10.252.7.131:8080', returnStatus: true
			 return (r == 0);
			 }
			 }
			}
        }
      }
      
       stage('Test curl') {
        steps{
          script {
            sh " curl -v 10.252.7.131:8080" 
          }
        }
      }
      
    }
      
}
